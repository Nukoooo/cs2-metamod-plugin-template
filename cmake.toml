# Reference: https://build-cpp.github.io/cmkr/cmake-toml
[project]
name = "cs2-plugin"
cmake-after="""
set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
set(SAFETYHOOK_FETCH_ZYDIS ON)
set(protobuf_USE_EXTERNAL_GTEST OFF)
"""

[fetch-content.expected]
git = "https://github.com/TartanLlama/expected"
tag = "3f0ca7b19253129700a073abfa6d8638d9f7c80c"

[target.safetyhook]
type = "static"
sources = ["safetyhook/safetyhook.cpp", "safetyhook/Zydis.c"]
include-directories = ["safetyhook/safetyhook.hpp", "safetyhook/Zydis.h"]
compile-features = ["cxx_std_20"]
link-libraries = ["tl::expected"]
alias = "safetyhook::safetyhook"
msvc.private-compile-options = ["/permissive-", "/W4", "/w14640"]
clang.private-compile-options = ["-Wall", "-Wextra", "-Wshadow", "-Wnon-virtual-dtor", "-pedantic"]
gcc.private-compile-options = ["-Wall", "-Wextra", "-Wshadow", "-Wnon-virtual-dtor", "-pedantic"]
cmake-after = """
if(SAFETYHOOK_USE_CXXMODULES)
    target_compile_definitions(safetyhook INTERFACE SAFETYHOOK_USE_CXXMODULES)
endif()
"""

[fetch-content.spdlog]
git = "https://github.com/gabime/spdlog"
tag = "v1.14.1"
shallow = true

[fetch-content.protobuf]
git = "https://github.com/noahbkim/cs2s-protobuf"
tag = "0a02547b680a319e73fd04d9efff88d901c3eaa8"

[target.mmsdk]
type = "interface"
include-directories= [
  "metamod-source/core",
  "metamod-source/core/sourcehook",
]
compile-definitions = ["META_IS_SOURCE2"]
alias = "mmsdk::mmsdk"

[target.hl2sdk]
type = "interface"
include-directories = [
  "hl2sdk",
  "hl2sdk/thirdparty/protobuf-3.21.8/src",
  "hl2sdk/common",
  "hl2sdk/game/shared",
  "hl2sdk/game/server",
  "hl2sdk/public",
  "hl2sdk/public/engine",
  "hl2sdk/public/mathlib",
  "hl2sdk/public/tier0",
  "hl2sdk/public/tier1",
  "hl2sdk/public/entity2",
  "hl2sdk/public/game/server",
]
compile-definitions = ["PLATFORM_64BITS"]
alias = "hl2sdk::hl2sdk"

[target.plugin]
type = "shared"
sources = [
  "hl2sdk/tier1/convar.cpp",
  "hl2sdk/tier1/generichash.cpp",
  "hl2sdk/tier1/keyvalues3.cpp",
  "hl2sdk/entity2/entityidentity.cpp",
  "hl2sdk/entity2/entitysystem.cpp",
  "hl2sdk/entity2/entitykeyvalues.cpp",
  "src/**.cpp",
  "src/**.cc",
  "src/**.hpp",
  "src/**.h",
]
include-directories = ["safetyhook/"]
compile-features = ["cxx_std_23"]
windows.compile-definitions = ["WIN32", "WINDOWS"]
linux.compile-definitions = ["LINUX"]
msvc.compile-definitions = ["COMPILER_MSVC64", "COMPILER_MSVC", "NOMINMAX", "MSVC"]
gcc.compile-definitions = ["GCC", "COMPILER_GCC"]
clang.compile-definitions = ["CLANG", "COMPILER_CLANG"]
msvc.private-compile-options = ["/MP", "/permissive-", "/utf-8", "/MT$<$<CONFIG:Debug>:d>"]
clang.private-compile-options = ["-std=libc++"]

link-libraries = ["hl2sdk::hl2sdk", "mmsdk::mmsdk", "safetyhook::safetyhook", "spdlog::spdlog", "libprotobuf",]
windows.link-libraries = [
    "hl2sdk/lib/public/win64/interfaces.lib",
    # "hl2sdk/lib/public/win64/2015/libprotobuf.lib",
    "hl2sdk/lib/public/win64/tier0.lib",
    "hl2sdk/lib/public/win64/tier1.lib",
    "hl2sdk/lib/public/win64/mathlib.lib",
]
linux.link-libraries = [
    "hl2sdk/lib/linux64/interfaces.a",
    "hl2sdk/lib/linux64/libtier0.so",
    "hl2sdk/lib/linux64/mathlib.a",
    "hl2sdk/lib/linux64/tier1.a",
]